create or replace view MCA.MCA.BOSEXX_FUNNEL_PRODUCTS_SESSION(
	DATE,
	PRODUCT_CLEAN,
	POST_PROP_COUNTRY,
	DEVICE_TYPE,
	CHANNEL,
	CHANNEL_DETAIL,
	PRODUCT_QUALITY,
	CHANNEL_CAMPAIGN,
	PRODUCT,
	SINGLE_PAGE_VISIT,
	HARD_BOUNCE,
	VISITS,
	NEW_VISIT,
	PDP,
	CARTS,
	ADDRESS,
	PAYMENT,
	UNITS,
	REVENUE,
	ORDERS,
	PDP_QCII,
	QCII_PXP_PDP
) as(
WITH TABLE_1 AS (
SELECT
DATE,
PRODUCT_CLEAN,
POST_PROP_COUNTRY,
DEVICE_TYPE,
CHANNEL,
CHANNEL_DETAIL,
SUM(SINGLE_PAGE_VISIT) AS SINGLE_PAGE_VISIT,
SUM(HARD_BOUNCE) AS HARD_BOUNCE,
SUM(VISITS) AS VISITS,
SUM(NEW_VISIT) AS NEW_VISIT,
SUM(PDP) AS PDP,
SUM(CARTS) AS CARTS,
SUM(ADDRESS) AS ADDRESS,
SUM(PAYMENT) AS PAYMENT,
SUM(UNITS) AS UNITS,
SUM(REVENUE) AS REVENUE,
SUM(ORDERS) AS ORDERS,
SUM(PDP_QCII) AS PDP_QCII,
SUM(QCII_PXP_PDP) AS QCII_PXP_PDP,
CASE WHEN PRODUCT_CLEAN LIKE '%fr%' THEN 'FR' ELSE 'FQ' END AS PRODUCT_QUALITY,
CASE
WHEN CHANNEL_DETAIL = 'Blog' THEN 'Blog-Ad hoc'
WHEN CHANNEL_DETAIL = 'Bose Connect App Messaging' THEN 'Bose Connect App Messaging-Go to market'
WHEN CHANNEL_DETAIL = 'Direct Mail' THEN 'Direct Mail-Brand'
WHEN CHANNEL_DETAIL = 'Print' THEN 'Print-Always on'
WHEN CHANNEL_DETAIL LIKE '%Social Organic%' THEN REPLACE(CHANNEL_DETAIL, 'Social Organic', 'Social Media')
WHEN CHANNEL_DETAIL = 'TV' THEN 'TV-Brand'
WHEN CHANNEL_DETAIL = 'Unspecified' THEN 'Natural/Direct Search'
ELSE CHANNEL_DETAIL END AS CHANNEL_CAMPAIGN,
CASE
WHEN PRODUCT_CLEAN='bose_soundbar_900' THEN 'Soundbar 900'
WHEN PRODUCT_CLEAN='bose_soundbar_900_fr' THEN 'Soundbar 900 FR'
WHEN PRODUCT_CLEAN='bose_smart_soundbar_600' THEN 'Soundbar 600'
WHEN PRODUCT_CLEAN='bose_music_amplifier' THEN 'Music Amplifier'
WHEN PRODUCT_CLEAN='noise_cancelling_headphones_700' THEN 'NCH700'
WHEN PRODUCT_CLEAN='noise_cancelling_headphones_700_fr' THEN 'NCH700 FR'
WHEN PRODUCT_CLEAN='noise_masking_sleepbuds_ii' THEN 'Sleepbuds II'
WHEN PRODUCT_CLEAN='noise_masking_sleepbuds_ii_fr' THEN 'Sleepbuds II FR'
WHEN PRODUCT_CLEAN='qc_earbuds' THEN 'QC Earbuds'
WHEN PRODUCT_CLEAN='qc_earbuds_fr' THEN 'QC Earbuds FR'
WHEN PRODUCT_CLEAN='qc_earbuds_ii' THEN 'QC Earbuds II'
WHEN PRODUCT_CLEAN='qc35_ii' THEN 'QC35II'
WHEN PRODUCT_CLEAN='qc35_ii_fr' THEN 'QC35II FR'
WHEN PRODUCT_CLEAN='qc45' THEN 'QC45'
WHEN PRODUCT_CLEAN='qc45_fr' THEN 'QC45 FR'
WHEN PRODUCT_CLEAN='soundcontrol_hearing_aids' THEN 'SC Hearing Aids'
WHEN PRODUCT_CLEAN='soundlink_flex' THEN 'Soundlink Flex'
WHEN PRODUCT_CLEAN='soundlink_flex_fr' THEN 'Soundlink Flex FR'
WHEN PRODUCT_CLEAN='soundlink_flex_bundle' THEN 'Soundlink Flex Bundle'  
WHEN PRODUCT_CLEAN='sport_earbuds' THEN 'Sport Earbuds'
WHEN PRODUCT_CLEAN='sport_earbuds_fr' THEN 'Sport Earbuds FR'
WHEN PRODUCT_CLEAN='wms_4' THEN 'WMS4'
WHEN PRODUCT_CLEAN='wms_4_fr' THEN 'WMS4 FR'
WHEN PRODUCT_CLEAN='a20_hdst' THEN 'A20 Aviation Headset'
ELSE 'Non-focus product' END AS PRODUCT,
CASE
WHEN POST_CAMPAIGN IS NULL THEN '0' ELSE
CONCAT(date,'-', post_campaign) END AS DATE_SOURCECODE,
CASE 
WHEN DATE BETWEEN '2022-06-17' AND '2022-07-13' THEN '00' ELSE 'XX' END AS IMPACTED_DATES,
CASE
WHEN POST_CAMPAIGN IS NULL THEN '0' ELSE
CONCAT(IMPACTED_DATES,'-', post_campaign) END AS DATE_SOURCECODE_2
FROM MCA.BOSEXX.MCA_VW_FUNNEL_PRODUCTS_SESSION_CONVERSIONRATE
WHERE PRODUCT_CLEAN IS NOT NULL
GROUP BY
DATE,
PRODUCT_CLEAN,
POST_PROP_COUNTRY,
DEVICE_TYPE,
CHANNEL,
CHANNEL_DETAIL,
POST_CAMPAIGN
), TABLE_2 AS (
SELECT
DATE,
PRODUCT_CLEAN,
POST_PROP_COUNTRY,
DEVICE_TYPE,
CHANNEL,
CHANNEL_DETAIL,
PRODUCT_QUALITY,
CHANNEL_CAMPAIGN,
PRODUCT,
DATE_SOURCECODE_2,
SUM(SINGLE_PAGE_VISIT) AS SINGLE_PAGE_VISIT,
SUM(HARD_BOUNCE) AS HARD_BOUNCE,
CASE WHEN DATE_SOURCECODE_2 IN (
'00-25_SA_QE_SE_00_CH_VM_201249', '00-25_SA_QE_SE_00_CH_VM_201252', '00-25_SA_QE_SE_00_CH_VM_201253', '00-25_SA_45_JI_00_CH_VU_200461', '00-25_SA_45_JI_00_CH_VU_200459',
'00-25_SA_45_JI_00_CH_VU_200462', '00-25_SA_45_JI_00_CH_VU_200463', '00-25_SA_QE_SE_00_CH_VM_201251', '00-25_SA_QE_SE_00_CH_VM_201254', '00-25_SA_45_JI_00_CH_VU_200460',
'00-25_SA_FL_SE_00_CH_VM_201223', '00-25_SA_45_SE_00_CH_VM_201244', '00-25_SA_FL_SE_00_CH_VM_201224', '00-25_SA_QE_SE_00_CH_VM_201250', '00-25_SA_FL_SE_00_CH_VM_201257',
'00-25_SA_45_SE_00_CH_VM_201181', '00-25_SA_QE_SE_00_CH_VM_201192', '00-25_SA_QE_SE_00_CH_VM_201650', '00-25_SA_FL_SE_00_CH_VM_201260', '00-25_SA_45_JI_00_CH_VU_200455',
'00-25_SA_45_JI_00_CH_VU_200458', '00-25_SA_45_JI_00_CH_VU_200457', '00-25_SA_45_SE_00_CH_VM_201183', '00-25_SA_45_SE_00_CH_VM_201649', '00-25_SA_45_JI_00_CH_VU_200454',
'00-25_SA_QE_SE_00_CH_VM_201189', '00-25_SA_FL_SE_00_CH_VM_201651', '00-25_SA_45_JI_00_CH_VU_200456', '00-25_SA_FL_SE_00_CH_VM_201259', '00-25_SA_QE_SE_00_CH_VM_201191',
'00-25_SA_45_SE_00_CH_VM_201182', '00-25_SA_45_SE_00_CH_VM_201247', '00-25_SA_45_SE_00_CH_VM_201248', '00-25_SA_FL_SE_00_CH_VM_201258', '00-25_SA_45_SE_00_CH_VM_201246',
'00-25_SA_45_SE_00_CH_VM_201245', '00-25_SA_45_SE_00_CH_VM_201184', '00-25_SA_QE_SE_00_CH_VM_201190', '00-25_SA_FL_SE_00_CH_VM_201256', '00-25_SA_QE_SE_00_CH_VM_201653',
'00-25_SA_45_SE_00_CH_VM_201243', '00-25_SA_FL_SE_00_CH_VM_201255', '00-25_SA_45_SE_00_CH_VM_201652', '00-25_SA_FL_SE_00_CH_VM_201654')
THEN SUM(VISITS)/(3.45) ELSE SUM(VISITS) END AS VISITS,
SUM(NEW_VISIT) AS NEW_VISIT,
CASE WHEN DATE_SOURCECODE_2 IN (
'00-25_SA_QE_SE_00_CH_VM_201249', '00-25_SA_QE_SE_00_CH_VM_201252', '00-25_SA_QE_SE_00_CH_VM_201253', '00-25_SA_45_JI_00_CH_VU_200461', '00-25_SA_45_JI_00_CH_VU_200459',
'00-25_SA_45_JI_00_CH_VU_200462', '00-25_SA_45_JI_00_CH_VU_200463', '00-25_SA_QE_SE_00_CH_VM_201251', '00-25_SA_QE_SE_00_CH_VM_201254', '00-25_SA_45_JI_00_CH_VU_200460',
'00-25_SA_FL_SE_00_CH_VM_201223', '00-25_SA_45_SE_00_CH_VM_201244', '00-25_SA_FL_SE_00_CH_VM_201224', '00-25_SA_QE_SE_00_CH_VM_201250', '00-25_SA_FL_SE_00_CH_VM_201257',
'00-25_SA_45_SE_00_CH_VM_201181', '00-25_SA_QE_SE_00_CH_VM_201192', '00-25_SA_QE_SE_00_CH_VM_201650', '00-25_SA_FL_SE_00_CH_VM_201260', '00-25_SA_45_JI_00_CH_VU_200455',
'00-25_SA_45_JI_00_CH_VU_200458', '00-25_SA_45_JI_00_CH_VU_200457', '00-25_SA_45_SE_00_CH_VM_201183', '00-25_SA_45_SE_00_CH_VM_201649', '00-25_SA_45_JI_00_CH_VU_200454',
'00-25_SA_QE_SE_00_CH_VM_201189', '00-25_SA_FL_SE_00_CH_VM_201651', '00-25_SA_45_JI_00_CH_VU_200456', '00-25_SA_FL_SE_00_CH_VM_201259', '00-25_SA_QE_SE_00_CH_VM_201191',
'00-25_SA_45_SE_00_CH_VM_201182', '00-25_SA_45_SE_00_CH_VM_201247', '00-25_SA_45_SE_00_CH_VM_201248', '00-25_SA_FL_SE_00_CH_VM_201258', '00-25_SA_45_SE_00_CH_VM_201246',
'00-25_SA_45_SE_00_CH_VM_201245', '00-25_SA_45_SE_00_CH_VM_201184', '00-25_SA_QE_SE_00_CH_VM_201190', '00-25_SA_FL_SE_00_CH_VM_201256', '00-25_SA_QE_SE_00_CH_VM_201653',
'00-25_SA_45_SE_00_CH_VM_201243', '00-25_SA_FL_SE_00_CH_VM_201255', '00-25_SA_45_SE_00_CH_VM_201652', '00-25_SA_FL_SE_00_CH_VM_201654')
THEN SUM(PDP)/(3.45) ELSE SUM(PDP) END AS PDP,
SUM(CARTS) AS CARTS,
SUM(ADDRESS) AS ADDRESS,
SUM(PAYMENT) AS PAYMENT,
SUM(UNITS) AS UNITS,
SUM(REVENUE) AS REVENUE,
SUM(ORDERS) AS ORDERS,
SUM(PDP_QCII) AS PDP_QCII,
SUM(QCII_PXP_PDP) AS QCII_PXP_PDP
FROM TABLE_1
WHERE DATE_SOURCECODE NOT IN
('2022-07-01-25_SA_FL_SE_00_CH_200090','2022-07-02-25_SA_FL_SE_00_CH_200090','2022-07-03-25_SA_FL_SE_00_CH_200090','2022-07-04-25_SA_FL_SE_00_CH_200090','2022-07-05-25_SA_FL_SE_00_CH_200090',
'2022-07-01-25_SA_FL_SE_00_CH_200101','2022-07-02-25_SA_FL_SE_00_CH_200101','2022-07-03-25_SA_FL_SE_00_CH_200101','2022-07-04-25_SA_FL_SE_00_CH_200101','2022-07-05-25_SA_FL_SE_00_CH_200101',
'2022-07-01-25_SA_FL_SE_00_CH_200117','2022-07-02-25_SA_FL_SE_00_CH_200117','2022-07-03-25_SA_FL_SE_00_CH_200117','2022-07-04-25_SA_FL_SE_00_CH_200117','2022-07-05-25_SA_FL_SE_00_CH_200117',
'2022-07-01-25_SA_FL_SE_00_CH_200122','2022-07-02-25_SA_FL_SE_00_CH_200122','2022-07-03-25_SA_FL_SE_00_CH_200122','2022-07-04-25_SA_FL_SE_00_CH_200122','2022-07-05-25_SA_FL_SE_00_CH_200122',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201085','2022-07-02-25_SA_FL_SE_00_CH_VM_201085','2022-07-03-25_SA_FL_SE_00_CH_VM_201085','2022-07-04-25_SA_FL_SE_00_CH_VM_201085','2022-07-05-25_SA_FL_SE_00_CH_VM_201085',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201086','2022-07-02-25_SA_FL_SE_00_CH_VM_201086','2022-07-03-25_SA_FL_SE_00_CH_VM_201086','2022-07-04-25_SA_FL_SE_00_CH_VM_201086','2022-07-05-25_SA_FL_SE_00_CH_VM_201086',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201087','2022-07-02-25_SA_FL_SE_00_CH_VM_201087','2022-07-03-25_SA_FL_SE_00_CH_VM_201087','2022-07-04-25_SA_FL_SE_00_CH_VM_201087','2022-07-05-25_SA_FL_SE_00_CH_VM_201087',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201091','2022-07-02-25_SA_FL_SE_00_CH_VM_201091','2022-07-03-25_SA_FL_SE_00_CH_VM_201091','2022-07-04-25_SA_FL_SE_00_CH_VM_201091','2022-07-05-25_SA_FL_SE_00_CH_VM_201091',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201092','2022-07-02-25_SA_FL_SE_00_CH_VM_201092','2022-07-03-25_SA_FL_SE_00_CH_VM_201092','2022-07-04-25_SA_FL_SE_00_CH_VM_201092','2022-07-05-25_SA_FL_SE_00_CH_VM_201092',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201093','2022-07-02-25_SA_FL_SE_00_CH_VM_201093','2022-07-03-25_SA_FL_SE_00_CH_VM_201093','2022-07-04-25_SA_FL_SE_00_CH_VM_201093','2022-07-05-25_SA_FL_SE_00_CH_VM_201093',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201097','2022-07-02-25_SA_FL_SE_00_CH_VM_201097','2022-07-03-25_SA_FL_SE_00_CH_VM_201097','2022-07-04-25_SA_FL_SE_00_CH_VM_201097','2022-07-05-25_SA_FL_SE_00_CH_VM_201097',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201098','2022-07-02-25_SA_FL_SE_00_CH_VM_201098','2022-07-03-25_SA_FL_SE_00_CH_VM_201098','2022-07-04-25_SA_FL_SE_00_CH_VM_201098','2022-07-05-25_SA_FL_SE_00_CH_VM_201098',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201099','2022-07-02-25_SA_FL_SE_00_CH_VM_201099','2022-07-03-25_SA_FL_SE_00_CH_VM_201099','2022-07-04-25_SA_FL_SE_00_CH_VM_201099','2022-07-05-25_SA_FL_SE_00_CH_VM_201099',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201103','2022-07-02-25_SA_FL_SE_00_CH_VM_201103','2022-07-03-25_SA_FL_SE_00_CH_VM_201103','2022-07-04-25_SA_FL_SE_00_CH_VM_201103','2022-07-05-25_SA_FL_SE_00_CH_VM_201103',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201104','2022-07-02-25_SA_FL_SE_00_CH_VM_201104','2022-07-03-25_SA_FL_SE_00_CH_VM_201104','2022-07-04-25_SA_FL_SE_00_CH_VM_201104','2022-07-05-25_SA_FL_SE_00_CH_VM_201104',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201105','2022-07-02-25_SA_FL_SE_00_CH_VM_201105','2022-07-03-25_SA_FL_SE_00_CH_VM_201105','2022-07-04-25_SA_FL_SE_00_CH_VM_201105','2022-07-05-25_SA_FL_SE_00_CH_VM_201105',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201223','2022-07-02-25_SA_FL_SE_00_CH_VM_201223','2022-07-03-25_SA_FL_SE_00_CH_VM_201223','2022-07-04-25_SA_FL_SE_00_CH_VM_201223','2022-07-05-25_SA_FL_SE_00_CH_VM_201223',
'2022-07-01-25_SA_FL_SE_00_CH_VM_201224','2022-07-02-25_SA_FL_SE_00_CH_VM_201224','2022-07-03-25_SA_FL_SE_00_CH_VM_201224','2022-07-04-25_SA_FL_SE_00_CH_VM_201224','2022-07-05-25_SA_FL_SE_00_CH_VM_201224'
)
GROUP BY
DATE,
PRODUCT_CLEAN,
POST_PROP_COUNTRY,
DEVICE_TYPE,
CHANNEL,
CHANNEL_DETAIL,
PRODUCT_QUALITY,
CHANNEL_CAMPAIGN,
PRODUCT,
DATE_SOURCECODE_2
)
SELECT
DATE,
PRODUCT_CLEAN,
POST_PROP_COUNTRY,
DEVICE_TYPE,
CHANNEL,
CHANNEL_DETAIL,
PRODUCT_QUALITY,
CHANNEL_CAMPAIGN,
PRODUCT,
SUM(SINGLE_PAGE_VISIT) AS SINGLE_PAGE_VISIT,
SUM(HARD_BOUNCE) AS HARD_BOUNCE,
SUM(VISITS) AS VISITS,
SUM(NEW_VISIT) AS NEW_VISIT,
SUM(PDP) AS PDP,
SUM(CARTS) AS CARTS,
SUM(ADDRESS) AS ADDRESS,
SUM(PAYMENT) AS PAYMENT,
SUM(UNITS) AS UNITS,
SUM(REVENUE) AS REVENUE,
SUM(ORDERS) AS ORDERS,
SUM(PDP_QCII) AS PDP_QCII,
SUM(QCII_PXP_PDP) AS QCII_PXP_PDP
FROM TABLE_2
GROUP BY
DATE,
PRODUCT_CLEAN,
POST_PROP_COUNTRY,
DEVICE_TYPE,
CHANNEL,
CHANNEL_DETAIL,
PRODUCT_QUALITY,
CHANNEL_CAMPAIGN,
PRODUCT
);
